name: Test Bot Signer

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  test-signing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Import PGP key
        run: |
          echo "${{ secrets.GITHUB_ACTIONS_BOT_PGP }}" | gpg --batch --import
          KEY_ID=$(gpg --list-secret-keys --with-colons github-actions[bot]@users.noreply.github.com | awk -F: '/^fpr:/ {print $10; exit}')
          echo "KEY_ID=$KEY_ID" >> $GITHUB_ENV

      - name: Configure git for PGP signing
        run: |
          git config user.name "github-actions-bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.signingkey $KEY_ID
          git config commit.gpgsign true

      - name: Update timestamp and create PGP signature
        run: |
          date +%s > last_modified.txt
          gpg --armor --detach-sign last_modified.txt
          mv last_modified.txt.asc last_modified.txt.pgp.asc

      - name: Commit with PGP signature
        run: |
          git add last_modified.txt last_modified.txt.pgp.asc
          git commit -S -m "Update timestamp with PGP signature

          Timestamp: $(cat last_modified.txt)
          Signed at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Import cosign key
        run: |
          echo "${{ secrets.GITHUB_ACTIONS_BOT_COSIGN }}" > cosign.key
        env:
          COSIGN_PASSWORD: ""

      - name: Create cosign blob signature
        run: |
          cosign sign-blob --key cosign.key --output-signature last_modified.txt.cosign last_modified.txt
          rm cosign.key
        env:
          COSIGN_PASSWORD: ""

      - name: Disable GPG commit signing
        run: |
          git config commit.gpgsign false

      - name: Commit cosign blob signature file
        run: |
          git add last_modified.txt.cosign
          git commit -m "Add cosign blob signature file

          Signed at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

      - name: Push commits
        run: git push origin ${{ github.ref_name }}
